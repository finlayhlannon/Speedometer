<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Pace Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            flex-direction: column;
        }
        .container {
            text-align: center;
        }
        h1 {
            font-size: 80px;
            margin: 0;
        }
        input {
            margin: 10px;
            padding: 10px;
            font-size: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 20px;
            margin-top: 10px;
        }
        #paceSettings {
            display: none; /* Initially hidden */
            margin-top: 20px;
        }
        #togglePaceButton {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="paceDisplay">0:00 min/km</h1>

        <!-- Toggle button for pace settings -->
        <button id="togglePaceButton" onclick="togglePaceSettings()">Pace</button>

        <!-- Pace settings input fields -->
        <div id="paceSettings">
            <div>
                <label for="minPace">Min Pace (min/km):</label>
                <input type="text" id="minPace" value="5:30">
            </div>
            <div>
                <label for="maxPace">Max Pace (min/km):</label>
                <input type="text" id="maxPace" value="5:00">
            </div>
            <button onclick="updatePaceRange()">Set Pace Range</button>
        </div>

        <!-- Audio elements for the mp3s -->
        <audio id="fasterAudio" loop>
            <source src="faster.mp3" type="audio/mp3">
            Your browser does not support the audio tag.
        </audio>
        <audio id="slowerAudio" loop>
            <source src="slower.mp3" type="audio/mp3">
            Your browser does not support the audio tag.
        </audio>
        <audio id="goodAudio" loop>
            <source src="good.mp3" type="audio/mp3">
            Your browser does not support the audio tag.
        </audio>
    </div>

    <script>
        let watchID;
        let speedHistory = []; // Store recent speed readings for smoothing
        const maxHistoryLength = 5; // Number of speed readings to average

        const fasterAudio = document.getElementById("fasterAudio");
        const slowerAudio = document.getElementById("slowerAudio");
        const goodAudio = document.getElementById("goodAudio");

        let minPace = 5.5; // Default min pace in minutes/km (5:30)
        let maxPace = 5.0; // Default max pace in minutes/km (5:00)

        // Automatically start tracking when the page loads
        window.onload = function() {
            startTracking();
        };

        // Function to update pace range based on user input
        function updatePaceRange() {
            const minPaceInput = document.getElementById("minPace").value;
            const maxPaceInput = document.getElementById("maxPace").value;

            // Convert min/max pace inputs (e.g., "5:30") to float values (e.g., 5.5)
            minPace = parseTimeToFloat(minPaceInput);
            maxPace = parseTimeToFloat(maxPaceInput);

            alert(`Pace range set to: ${minPaceInput} min/km (min) and ${maxPaceInput} min/km (max)`);
        }

        // Convert "min:sec" string format to float (minutes)
        function parseTimeToFloat(timeStr) {
            const parts = timeStr.split(":");
            const minutes = parseInt(parts[0]);
            const seconds = parseInt(parts[1]) / 60;
            return minutes + seconds;
        }

        function startTracking() {
            if ('geolocation' in navigator) {
                watchID = navigator.geolocation.watchPosition(calculatePace, handleError, {
                    enableHighAccuracy: true, // Request best possible accuracy
                    maximumAge: 1000,         // Maximum age of the cached position in ms
                    timeout: 10000            // Timeout in ms before error callback
                });
            }
        }

        function calculatePace(position) {
            const speedMps = position.coords.speed;

            if (speedMps !== null && speedMps > 0) {
                const speedKmh = speedMps * 3.6; // Convert m/s to km/h
                
                // Add current speed to history
                speedHistory.push(speedKmh);
                if (speedHistory.length > maxHistoryLength) {
                    speedHistory.shift(); // Keep only the last 'maxHistoryLength' values
                }
                
                // Calculate average speed for smoother display
                const averageSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
                
                // Convert km/h to minutes per kilometer
                const minutesPerKm = 60 / averageSpeed;
                const minutes = Math.floor(minutesPerKm);
                const seconds = Math.floor((minutesPerKm - minutes) * 60);

                // Display the pace in minutes and seconds
                document.getElementById('paceDisplay').innerHTML = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} min/km`;

                // Determine which audio to play based on the custom pace range
                if (minutesPerKm > minPace) {
                    playAudio("faster");
                } else if (minutesPerKm < maxPace) {
                    playAudio("slower");
                } else {
                    playAudio("good");
                }
            } else {
                document.getElementById('paceDisplay').innerHTML = "0:00 min/km";
                playAudio("good"); // Default to good if not moving
            }
        }

        function playAudio(type) {
            if (type === "faster") {
                if (fasterAudio.paused) {
                    fasterAudio.play();
                }
                slowerAudio.pause();
                goodAudio.pause();
            } else if (type === "slower") {
                if (slowerAudio.paused) {
                    slowerAudio.play();
                }
                fasterAudio.pause();
                goodAudio.pause();
            } else {
                if (goodAudio.paused) {
                    goodAudio.play();
                }
                fasterAudio.pause();
                slowerAudio.pause();
            }
        }

        function handleError(error) {
            document.getElementById('paceDisplay').innerHTML = "0:00 min/km"; // Show 0 if there is an error
            playAudio("good"); // Default to good if there is an error
        }

        // Toggle visibility of pace settings
        function togglePaceSettings() {
            const paceSettings = document.getElementById("paceSettings");
            if (paceSettings.style.display === "none" || paceSettings.style.display === "") {
                paceSettings.style.display = "block"; // Show settings
            } else {
                paceSettings.style.display = "none"; // Hide settings
            }
        }
    </script>

</body>
</html>
